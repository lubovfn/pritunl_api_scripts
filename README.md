# Pritunl API Scripts

## 1) Управление сервером Pritunl через API

Для управления сервером Pritunl через API потребуется подписка **Enterprise** и учетная запись с правами администратора внутри Pritunl, для которой будут получены **token** и **secret**.

### Установка `pritunl-api`
Установите `pritunl-api` с помощью pip:
```
pip install pritunl-api
```
Подробнее: [Pritunl API на PyPI](https://pypi.org/project/pritunl-api/#cli-usage)

---

## 2) Переменные окружения

Загрузите учетные данные API Pritunl в переменные окружения:
```
export PRITUNL_BASE_URL="https://YOUR_domain"
export PRITUNL_API_TOKEN="<PRITUNL API TOKEN>"
export PRITUNL_API_SECRET="<PRITUNL API SECRET>"
```

---

## Конфигурация

Так как нет простого способа добавлять маршруты на сервер через API, можно использовать следующий подход.

### Создание файла конфигурации `pritunl_settings.yml`
```yaml
api_secret: ваш_secret
api_token: ваш_токен
base_url: https://vpndemo.it.com  # ваш домен
routes:
  - network:
      - 10.90.10.0/24
      - 0.0.0.0/32
      - 10.29.80.0/24
      - 10.33.56.0/24
      - 10.41.55.0/24
      - 10.79.98.0/24
    server_id: ваш_сервер_id  # можно найти через средства разработчика в Google Chrome
servers:
  - dns_servers:
      - 8.8.8.8
    id: ваш_сервер_id
    name: vpndemo
    nat: false
    net_gateway: false
    network: 10.80.50.0/24
    port: 15626
```

---

## Добавление и удаление маршрутов

Для работы с маршрутами сначала необходимо получить конфигурацию сервера и сохранить её в файл.

Через API маршруты привязываются по `ID: route`, который **не равен самой подсети**.

### Получение конфигурации сервера
- Чтобы получить конфигурацию **одного** сервера, используем скрипт `get_server.py`.
- Чтобы получить список **всех** серверов и записать настройки в конфигурационный файл, используем `get_all_server.py`.

**Важно:** Перед каждым запуском рекомендуется запускать `get_server.py`, чтобы получить актуальную конфигурацию и записать её в файл.

---

## Добавление маршрутов

В этом примере рассмотрены два способа:

### 1. Добавление маршрутов через текстовый файл
1. Создайте файл `routes_to_add.txt`.
2. Используйте скрипт `add_routes_to_txt.py` для добавления маршрутов.

### 2. Добавление маршрутов из JSON
- Парсим JSON и добавляем IP-адреса с помощью `add_route_azure.py`.
- Парсим JSON и добавляем определенные элементы (например, маршруты для `Azure DevOps` и `AzureCloud.westeurope`).  
  В этом случае маршруты автоматически записываются в файл `routes_to_delete.txt`, чтобы при следующем запуске можно было удалить старые и добавить новые.  
  **Дубликаты игнорируются**. Используем `add-routeAZ_to_del.py`.

---

## Удаление маршрутов

### Получение списка актуальных маршрутов
Перед удалением маршрутов **обязательно** обновите конфигурацию, запустив:
```
python3 get_server.py
```

### Удаление маршрутов из файла `routes_to_delete.txt`
1. В файле `routes_to_delete.txt` укажите маршруты, которые нужно удалить.
2. Запустите скрипт `python3 delete-route.py`.

---

## Автоматическое обновление конфигурационного файла `pritunl_settings.yml`

Если вам нужно автоматически записывать актуальные настройки в `pritunl_settings.yml`, перед запуском скрипта **очистите файл**, оставив в нем только базовые параметры:
```yaml
api_secret: ваш_secret
api_token: ваш_токен
base_url: https://vpndemo.it.com  # ваш домен
```

---
